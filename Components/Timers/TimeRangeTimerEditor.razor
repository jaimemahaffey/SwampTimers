@using SwampTimers.Models

<MudPaper Class="pa-4">
    <MudTextField @bind-Value="Timer.Name"
                  Label="Timer Name"
                  Required="true"
                  Variant="Variant.Outlined"
                  Class="mb-3" />

    <MudTextField @bind-Value="Timer.Description"
                  Label="Description"
                  Lines="2"
                  Variant="Variant.Outlined"
                  Class="mb-3" />

    <MudTimePicker @bind-Time="_onTime"
                   Label="On Time"
                   Variant="Variant.Outlined"
                   Class="mb-3" />

    <MudTimePicker @bind-Time="_offTime"
                   Label="Off Time"
                   Variant="Variant.Outlined"
                   Class="mb-3" />

    <MudText Typo="Typo.subtitle2" Class="mb-2">Active Days (leave empty for every day)</MudText>
    <MudStack Row="true" Spacing="1" Class="mb-3">
        @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
        {
            <MudChip T="string"
                     Size="Size.Small"
                     Color="@(Timer.ActiveDays.Contains(day) ? Color.Primary : Color.Default)"
                     OnClick="@(() => ToggleDay(day))">
                @day.ToString().Substring(0, 3)
            </MudChip>
        }
    </MudStack>

    <MudSwitch @bind-Value="Timer.IsEnabled"
               Label="Enabled"
               Color="Color.Success" />

    @if (ShowDurationInfo)
    {
        var duration = GetDuration();
        <MudAlert Severity="@(duration.TotalHours > 24 ? Severity.Warning : Severity.Info)" Class="mt-3">
            @if (Timer.OffTime < Timer.OnTime)
            {
                <MudText>This timer spans midnight (@duration.Hours hours, @duration.Minutes minutes)</MudText>
            }
            else
            {
                <MudText>Duration: @duration.Hours hours, @duration.Minutes minutes</MudText>
            }
        </MudAlert>
    }
</MudPaper>

@code {
    [Parameter]
    public TimeRangeTimer Timer { get; set; } = new();

    [Parameter]
    public bool ShowDurationInfo { get; set; } = true;

    private TimeSpan? _onTime
    {
        get => Timer.OnTime.ToTimeSpan();
        set
        {
            if (value.HasValue)
            {
                Timer.OnTime = TimeOnly.FromTimeSpan(value.Value);
            }
        }
    }

    private TimeSpan? _offTime
    {
        get => Timer.OffTime.ToTimeSpan();
        set
        {
            if (value.HasValue)
            {
                Timer.OffTime = TimeOnly.FromTimeSpan(value.Value);
            }
        }
    }

    private void ToggleDay(DayOfWeek day)
    {
        if (Timer.ActiveDays.Contains(day))
        {
            Timer.ActiveDays.Remove(day);
        }
        else
        {
            Timer.ActiveDays.Add(day);
        }
    }

    private TimeSpan GetDuration()
    {
        if (Timer.OffTime < Timer.OnTime)
        {
            // Spans midnight
            var timeUntilMidnight = new TimeSpan(24, 0, 0) - Timer.OnTime.ToTimeSpan();
            var timeAfterMidnight = Timer.OffTime.ToTimeSpan();
            return timeUntilMidnight + timeAfterMidnight;
        }
        else
        {
            return Timer.OffTime.ToTimeSpan() - Timer.OnTime.ToTimeSpan();
        }
    }
}

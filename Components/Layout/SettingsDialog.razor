@using SwampTimers.Models
@using SwampTimers.Models.HomeAssistant
@using SwampTimers.Services.HomeAssistant
@using Microsoft.Extensions.Options
@inject IOptions<StorageOptions> StorageOptions
@inject HomeAssistantClientInfo ClientInfo
@inject IHomeAssistantClient HaClient

<MudDialog>
	<TitleContent>
		<MudText Typo="Typo.h6">
			<MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
			Settings
		</MudText>
	</TitleContent>
	<DialogContent>
		<MudStack Spacing="4">
			<!-- Home Assistant Connection Status -->
			<MudText Typo="Typo.subtitle1" Class="mt-2">Home Assistant Integration</MudText>
			
			<MudPaper Class="pa-3" Outlined="true">
				<MudStack Spacing="2">
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
						<MudIcon Icon="@Icons.Material.Filled.Home" 
						         Color="@(ClientInfo.IsRealClient ? Color.Success : Color.Warning)" />
						<MudText Typo="Typo.subtitle2">Client Mode</MudText>
						<MudChip T="string" 
						         Color="@(ClientInfo.IsRealClient ? Color.Success : Color.Warning)" 
						         Size="Size.Small">
							@(ClientInfo.IsRealClient ? "Real" : "Mock")
						</MudChip>
					</MudStack>
					
					@if (!ClientInfo.IsRealClient)
					{
						<MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
							Using mock client. SUPERVISOR_TOKEN not found.
							Ensure the add-on has <code>homeassistant_api: true</code> in config.
						</MudAlert>
					}
					
					<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
						<MudIcon Icon="@GetConnectionIcon()" 
						         Color="@GetConnectionColor()" 
						         Size="Size.Small" />
						<MudText Typo="Typo.body2">
							@if (_isCheckingConnection)
							{
								<text>Checking connection...</text>
							}
							else if (_isConnected)
							{
								<text>Connected - @_entityCount entities available</text>
							}
							else
							{
								<text>Not connected</text>
							}
						</MudText>
						<MudIconButton Icon="@Icons.Material.Filled.Refresh" 
						               Size="Size.Small" 
						               OnClick="CheckConnection"
						               Disabled="_isCheckingConnection"
						               Title="Test connection" />
					</MudStack>
				</MudStack>
			</MudPaper>

			<MudDivider />

			<!-- Storage Configuration -->
			<MudText Typo="Typo.subtitle1">Storage Configuration</MudText>
			
			<MudAlert Severity="Severity.Info" Dense="true">
				Storage settings are configured via add-on options. Changes require a restart.
			</MudAlert>

			<MudStack Spacing="2">
				<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
					<MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" />
					<MudText Typo="Typo.subtitle2">Current Storage</MudText>
					<MudChip T="string" Color="@GetStorageTypeColor()" Size="Size.Small">
						@_storageType.ToString()
					</MudChip>
				</MudStack>
				<MudText Typo="Typo.body2" Class="mud-text-secondary ml-7">
					@_storagePath
				</MudText>
			</MudStack>
		</MudStack>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">Close</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter]
	private IMudDialogInstance? MudDialog { get; set; }

	private StorageType _storageType = StorageType.Sqlite;
	private string _storagePath = string.Empty;
	
	private bool _isCheckingConnection = false;
	private bool _isConnected = false;
	private int _entityCount = 0;

	protected override async Task OnInitializedAsync()
	{
		var options = StorageOptions.Value;
		_storageType = options.StorageType;

		_storagePath = _storageType switch
		{
			StorageType.Sqlite => options.SqlitePath,
			StorageType.Yaml => options.YamlPath,
			_ => "Unknown"
		};
		
		await CheckConnection();
	}

	private async Task CheckConnection()
	{
		_isCheckingConnection = true;
		StateHasChanged();
		
		try
		{
			_isConnected = await HaClient.IsConnectedAsync();
			if (_isConnected)
			{
				var entities = await HaClient.GetEntitiesAsync();
				_entityCount = entities.Count();
			}
			else
			{
				_entityCount = 0;
			}
		}
		catch
		{
			_isConnected = false;
			_entityCount = 0;
		}
		finally
		{
			_isCheckingConnection = false;
			StateHasChanged();
		}
	}

	private string GetConnectionIcon()
	{
		if (_isCheckingConnection) return Icons.Material.Filled.Sync;
		return _isConnected ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error;
	}

	private Color GetConnectionColor()
	{
		if (_isCheckingConnection) return Color.Default;
		return _isConnected ? Color.Success : Color.Error;
	}

	private Color GetStorageTypeColor()
	{
		return _storageType switch
		{
			StorageType.Sqlite => Color.Primary,
			StorageType.Yaml => Color.Secondary,
			_ => Color.Default
		};
	}

	private void Close() => MudDialog?.Close();
}

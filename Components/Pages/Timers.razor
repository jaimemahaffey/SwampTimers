@page "/"
@page "/timers"
@using SwampTimers.Models
@using SwampTimers.Services
@using PeriodicEvents.Proto
@inject ITimerService TimerService
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Timer Schedules</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Timer Schedules</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      OnClick="@(() => OpenCreateDialog("Duration"))"
                      StartIcon="@Icons.Material.Filled.Timer">
                Add Duration Timer
            </MudButton>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Secondary"
                      OnClick="@(() => OpenCreateDialog("TimeRange"))"
                      StartIcon="@Icons.Material.Filled.Schedule">
                Add Time Range Timer
            </MudButton>
            <MudButton Variant="Variant.Filled"
                      Color="Color.Tertiary"
                      OnClick="@(() => OpenCreateDialog("Recurring"))"
                      StartIcon="@Icons.Material.Filled.EventRepeat">
                Add Recurring Timer
            </MudButton>
            <MudSpacer />
            <MudButton Variant="Variant.Outlined"
                      OnClick="LoadTimers"
                      StartIcon="@Icons.Material.Filled.Refresh">
                Refresh
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
    else if (_timers.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No timers configured. Click the buttons above to create your first timer.</MudAlert>
    }
    else
    {
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0">
            <MudTabPanel Text="Cards" Icon="@Icons.Material.Filled.ViewModule">
                <MudGrid Class="mt-4">
            @foreach (var timer in _timers)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@timer.Name</MudText>
                                <MudChip T="string" Size="Size.Small" Color="@GetTimerTypeColor(timer.TimerType)">
                                    @timer.TimerType
                                </MudChip>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudSwitch @bind-Value="timer.IsEnabled"
                                          Color="Color.Success"
                                          @onclick="@(() => ToggleTimer(timer.Id))" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@timer.Description</MudText>

                            @if (timer is DurationTimer durationTimer)
                            {
                                <MudText Typo="Typo.body2" Class="mt-2">
                                    <strong>Start:</strong> @durationTimer.StartTime.ToString("hh:mm tt")
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Duration:</strong> @durationTimer.DurationMinutes minutes
                                </MudText>
                            }
                            else if (timer is TimeRangeTimer timeRangeTimer)
                            {
                                <MudText Typo="Typo.body2" Class="mt-2">
                                    <strong>On:</strong> @timeRangeTimer.OnTime.ToString("hh:mm tt")
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Off:</strong> @timeRangeTimer.OffTime.ToString("hh:mm tt")
                                </MudText>
                            }
                            else if (timer is RecurringTimer recurringTimer)
                            {
                                <MudText Typo="Typo.body2" Class="mt-2">
                                    <strong>Event:</strong> @recurringTimer.Event.Name
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Every:</strong> @FormatPeriod(recurringTimer.Event.PeriodType, recurringTimer.Event.PeriodValue)
                                </MudText>
                                @if (recurringTimer.CurrentOccurrence != null)
                                {
                                    var scheduledDate = new DateTime(
                                        recurringTimer.CurrentOccurrence.ScheduledDate.Year,
                                        recurringTimer.CurrentOccurrence.ScheduledDate.Month,
                                        recurringTimer.CurrentOccurrence.ScheduledDate.Day);
                                    <MudText Typo="Typo.body2">
                                        <strong>Next Due:</strong> @scheduledDate.ToString("MMM d, yyyy")
                                    </MudText>
                                }
                            }

                            @{
                                var isActive = timer.IsActiveAt(DateTime.Now);
                                var nextEvent = isActive ? timer.GetNextDeactivation(DateTime.Now) : timer.GetNextActivation(DateTime.Now);
                            }

                            <MudChip T="string"
                                    Size="Size.Small"
                                    Color="@(isActive ? Color.Success : Color.Default)"
                                    Class="mt-2">
                                @(isActive ? (timer is RecurringTimer ? "Due" : "Active Now") : "Inactive")
                            </MudChip>

                            @if (timer is not RecurringTimer && nextEvent.HasValue)
                            {
                                <MudText Typo="Typo.caption" Class="mt-1">
                                    Next @(isActive ? "off" : "on"): @nextEvent.Value.ToString("ddd, MMM d @ h:mm tt")
                                </MudText>
                            }
                        </MudCardContent>
                        <MudCardActions>
                            @if (timer is RecurringTimer rt && rt.CurrentOccurrence != null && timer.IsActiveAt(DateTime.Now))
                            {
                                <MudButton Size="Size.Small"
                                          Color="Color.Success"
                                          Variant="Variant.Filled"
                                          OnClick="@(() => CompleteRecurringTimer(rt))">
                                    Complete
                                </MudButton>
                            }
                            <MudButton Size="Size.Small"
                                      Color="Color.Primary"
                                      OnClick="@(() => EditTimer(timer))">
                                Edit
                            </MudButton>
                            <MudButton Size="Size.Small"
                                      Color="Color.Error"
                                      OnClick="@(() => DeleteTimer(timer.Id))">
                                Delete
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Timeline" Icon="@Icons.Material.Filled.Timeline">
                <div class="mt-4">
                    <TimelineView Timers="_timers" OnTimerUpdated="OnTimelineTimerUpdated" />
                </div>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    private List<TimerSchedule> _timers = new();
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTimers();
    }

    private async Task LoadTimers()
    {
        _loading = true;
        try
        {
            _timers = await TimerService.GetAllAsync();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenCreateDialog(string timerType)
    {
        TimerSchedule newTimer = timerType switch
        {
            "Duration" => new DurationTimer
            {
                Name = "New Duration Timer",
                Description = "Edit this timer",
                StartTime = TimeOnly.FromDateTime(DateTime.Now),
                DurationMinutes = 60,
                ActiveDays = new List<DayOfWeek>()
            },
            "TimeRange" => new TimeRangeTimer
            {
                Name = "New Time Range Timer",
                Description = "Edit this timer",
                OnTime = TimeOnly.FromDateTime(DateTime.Now),
                OffTime = TimeOnly.FromDateTime(DateTime.Now.AddHours(1)),
                ActiveDays = new List<DayOfWeek>()
            },
            "Recurring" => CreateNewRecurringTimer(),
            _ => throw new ArgumentException("Invalid timer type")
        };

        var parameters = new DialogParameters
        {
            ["Timer"] = newTimer,
            ["IsNew"] = true
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<TimerEditDialog>($"Create {timerType} Timer", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is TimerSchedule createdTimer)
        {
            await TimerService.CreateAsync(createdTimer);
            await LoadTimers();
        }
    }

    private RecurringTimer CreateNewRecurringTimer()
    {
        var timer = new RecurringTimer
        {
            Name = "New Recurring Timer",
            Description = "Edit this timer",
            Event = new PeriodicEvent
            {
                Id = Guid.NewGuid().ToString(),
                Name = "New Event",
                PeriodType = PeriodType.Days,
                PeriodValue = 7
            }
        };
        timer.InitializeFirstOccurrence(DateTime.Today);
        return timer;
    }

    private async Task EditTimer(TimerSchedule timer)
    {
        var parameters = new DialogParameters
        {
            ["Timer"] = timer,
            ["IsNew"] = false
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<TimerEditDialog>("Edit Timer", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is TimerSchedule editedTimer)
        {
            await TimerService.UpdateAsync(editedTimer);
            await LoadTimers();
        }
    }

    private async Task ToggleTimer(int id)
    {
        await TimerService.ToggleEnabledAsync(id);
        await LoadTimers();
    }

    private async Task DeleteTimer(int id)
    {
        var timer = _timers.FirstOrDefault(t => t.Id == id);
        if (timer == null)
            return;

        var result = await DialogService.ShowMessageBox(
            "Delete Timer",
            $"Are you sure you want to delete '{timer.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            await TimerService.DeleteAsync(id);
            await LoadTimers();
        }
    }

    private async Task CompleteRecurringTimer(RecurringTimer timer)
    {
        timer.CompleteCurrentOccurrence(DateTime.Today);
        await TimerService.UpdateAsync(timer);
        await LoadTimers();
    }

    private async Task OnTimelineTimerUpdated(TimerSchedule timer)
    {
        await TimerService.UpdateAsync(timer);
        await LoadTimers();
    }

    private static Color GetTimerTypeColor(string timerType) => timerType switch
    {
        "Duration" => Color.Primary,
        "TimeRange" => Color.Secondary,
        "Recurring" => Color.Tertiary,
        _ => Color.Default
    };

    private static string FormatPeriod(PeriodType periodType, int value) => periodType switch
    {
        PeriodType.Days => value == 1 ? "1 day" : $"{value} days",
        PeriodType.Weeks => value == 1 ? "1 week" : $"{value} weeks",
        PeriodType.Months => value == 1 ? "1 month" : $"{value} months",
        PeriodType.Years => value == 1 ? "1 year" : $"{value} years",
        _ => $"{value} days"
    };
}
